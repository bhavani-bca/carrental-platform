<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <style>
		body {
		    font-family: 'Poppins', sans-serif;
		    margin: 0;
		    padding: 0;
		    background-color: #f4f6f9;
		    text-align: center;
		    color: #333;
		}

		.container {
		    display: flex;
		    justify-content: center;
		    align-items: flex-start;
		    gap: 24px;
		    max-width: 960px;
		    margin: 60px auto;
		    padding: 24px;
		}

		.profile-container, .update-container {
		    flex: 1;
		    background: #ffffff;
		    padding: 30px;
		    border-radius: 16px;
		    box-shadow: 0px 6px 18px rgba(0, 0, 0, 0.08);
		    text-align: left;
		    transition: transform 0.3s ease, box-shadow 0.3s ease;
		}

		.profile-container:hover, .update-container:hover {
		    transform: translateY(-6px);
		    box-shadow: 0px 10px 24px rgba(0, 0, 0, 0.12);
		}

		.update-container {
		    display: none;
		}

		.profile-item {
		    margin-bottom: 14px;
		    font-size: 17px;
		    color: #444;
		}

		.profile-item strong {
		    font-size: 15px;
		    color: #777;
		    display: block;
		    margin-bottom: 6px;
		}

		.profile-img {
		    display: block;
		    width: 100%;
		    height: auto;
		    margin-top: 12px;
		    border-radius: 8px;
		}

		button {
		    display: block;
		    width: 100%;
		    padding: 14px;
		    margin-top: 14px;
		    border: none;
		    border-radius: 8px;
		    font-size: 17px;
		    font-weight: 600;
		    cursor: pointer;
		    transition: all 0.3s ease;
		    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
		}

		.show-update-btn { background-color: #007BFF; color: white; }
		.update-btn { background-color: #28a745; color: white; }
		.reset-password-btn { background-color: #dc3545; color: white; }
		.delete-account-btn { background-color: #6c757d; color: white; }
		.back-btn { background-color: #343a40; color: white; }

		button:hover {
		    opacity: 0.85;
		    transform: scale(1.06);
		}

		/* LOADING OVERLAY */
		.loading-overlay {
		    position: fixed;
		    top: 0;
		    left: 0;
		    width: 100%;
		    height: 100%;
		    background: rgba(0, 0, 0, 0.6);
		    display: flex;
		    justify-content: center;
		    align-items: center;
		    color: white;
		    font-size: 22px;
		    font-weight: bold;
		    transition: opacity 0.3s ease;
		}

		.loading-text {
		    background: rgba(0, 0, 0, 0.85);
		    padding: 22px;
		    border-radius: 12px;
		    font-size: 20px;
		    font-weight: bold;
		    box-shadow: 0px 6px 12px rgba(0, 0, 0, 0.15);
		}

		
    </style>
    <script>
		
		
		window.onload = async function () {
		    const urlParams = new URLSearchParams(window.location.search);
		    const userEmail = urlParams.get("email");

		    console.log("Extracted Email:", userEmail); // Debugging Log

		    if (!userEmail || userEmail.trim() === "") {
		        alert("Invalid user profile!");
		        window.location.href = "login.html";
		        return;
		    }

		    // Auto-fill email input field
		    document.getElementById("email").value = userEmail;

		    try {
		        const response = await fetch(`http://localhost:8080/auth/profile/${encodeURIComponent(userEmail)}`);

		        console.log("Response Status:", response.status);
		        console.log("Response Headers:", response.headers);

		        if (!response.ok) throw new Error("Failed to fetch profile");

		        const userData = await response.json();
		        console.log("Fetched User Data:", userData);

		        document.getElementById("profileInfo").innerHTML = `
		            <div class="profile-item"><strong>First Name:</strong> <span>${userData.firstName}</span></div>
		            <div class="profile-item"><strong>Last Name:</strong> <span>${userData.lastName}</span></div>
		            <div class="profile-item"><strong>Email:</strong> <span>${userData.email}</span></div>
		            <div class="profile-item"><strong>Address:</strong> <span>${userData.address}</span></div>
		            <div class="profile-item"><strong>Contact:</strong> <span>${userData.contact}</span></div>
		            <div class="profile-item"><strong>Licence:</strong> <span>${userData.licence}</span></div>
		            <div class="profile-item"><strong>Licence Image:</strong> 
		                <img src="${userData.licenceImg}" alt="Licence Image" class="profile-img">
		            </div>
		        `;

		    } catch (error) {
		        console.error("Error fetching profile:", error);
		        document.getElementById("profileInfo").innerHTML = "<p>Failed to load profile details.</p>";
		    }
		};

		
		function showLoading() {
		    const loadingOverlay = document.getElementById("loadingOverlay");
		    if (loadingOverlay) {
		        loadingOverlay.style.display = "flex";
		    } else {
		        console.error("❌ Error: Loading overlay not found!");
		    }
		}

		function hideLoading() {
		    const loadingOverlay = document.getElementById("loadingOverlay");
		    if (loadingOverlay) {
		        loadingOverlay.style.display = "none";
		    } else {
		        console.error("❌ Error: Loading overlay not found!");
		    }
		}


        
		function showUpdateForm() {
		    const emailElement = document.querySelector("#profileInfo .profile-item:nth-child(3) span");

		    if (!emailElement || !emailElement.innerText) {
		        alert("Invalid user profile!");
		        return;
		    }

		    // Auto-fill email field before updating
		    document.getElementById("email").value = emailElement.innerText.trim();

		    const profileData = document.getElementById("profileInfo").getElementsByTagName("span");

		    if (profileData.length >= 6) {
		        document.getElementById("firstName").value = profileData[0].innerText;
		        document.getElementById("lastName").value = profileData[1].innerText;
		        document.getElementById("address").value = profileData[3].innerText;
		        document.getElementById("contact").value = profileData[4].innerText;
		        document.getElementById("licence").value = profileData[5].innerText;

		        // Extract Licence Image URL
		        const licenceImgElement = document.querySelector(".profile-img");
		        document.getElementById("licenceImg").value = licenceImgElement ? licenceImgElement.src : "";
		    }

		    document.querySelector(".update-container").style.display = "block";
		}


		async function updateProfile(event) {
		    event.preventDefault(); // Prevent default form submission

		    const email = document.getElementById("email").value.trim();
		    if (!email) {
		        alert("Invalid user profile!");
		        return;
		    }

		    const updatedUser = {
		        email: email,  // Ensure email is included
		        firstName: document.getElementById("firstName").value.trim(),
		        lastName: document.getElementById("lastName").value.trim(),
		        address: document.getElementById("address").value.trim(),
		        contact: document.getElementById("contact").value.trim(),
		        licence: document.getElementById("licence").value.trim(),
		        licenceImg: document.getElementById("licenceImg").value.trim()
		    };

		    console.log("Updating User Data:", updatedUser); // Debugging Log

		    try {
		        const response = await fetch("http://localhost:8080/auth/profile/update", {
		            method: "PUT", // Ensure this matches your backend
		            headers: {
		                "Content-Type": "application/json"
		            },
		            body: JSON.stringify(updatedUser)
		        });

		        let responseData;
		        const contentType = response.headers.get("Content-Type");

		        if (contentType && contentType.includes("application/json")) {
		            responseData = await response.json();
		        } else {
		            responseData = await response.text(); // Handle plain text responses
		        }

		        console.log("Server Response:", responseData);

		        if (!response.ok) throw new Error(responseData || "Profile update failed!");

		        alert("Profile updated successfully!");
		        window.location.reload(); // Reload page to show updated details
		    } catch (error) {
		        console.error("Error updating profile:", error);
		        alert(error.message); // Show plain text error from backend
		    }
		}

		
		
		async function resetPassword() {
		    const newPassword = prompt("Enter new password:");
		    if (!newPassword) return;

		    const email = document.getElementById("email").value;
		    
		    showLoading(); // Show loading before request starts

		    try {
		        const response = await fetch("http://localhost:8080/auth/reset-password", {
		            method: "POST",
		            headers: { "Content-Type": "application/json" },
		            body: JSON.stringify({ email, newPassword })
		        });

		        if (!response.ok) throw new Error("Password reset failed");

		        alert("Password reset successful!");
		    } catch (error) {
		        console.error("Error resetting password:", error);
		        alert("Password reset failed");
		    } finally {
		        hideLoading(); // Hide loading after request completes
		    }
		}

		
		async function requestDeleteOTP() {
		    const email = document.getElementById("email").value;
		    showLoading(); // Show loading before making the request

		    try {
		        const response = await fetch("http://localhost:8080/auth/delete/request-otp", {
		            method: "POST",
		            headers: { "Content-Type": "application/json" },
		            body: JSON.stringify({ email })
		        });

		        if (!response.ok) throw new Error("Failed to request OTP");
		        alert("OTP sent to your email. Enter the OTP to confirm account deletion.");

		        const otp = prompt("Enter OTP to confirm account deletion:");
		        if (!otp) {
		            hideLoading(); // Hide loading if user cancels OTP input
		            return;
		        }

		        const deleteResponse = await fetch("http://localhost:8080/auth/delete/verify", {
		            method: "DELETE",
		            headers: { "Content-Type": "application/json" },
		            body: JSON.stringify({ email, otp })
		        });

		        if (!deleteResponse.ok) throw new Error("Account deletion failed");

		        alert("Account deleted successfully!");
		        window.location.href = "login.html";
		    } catch (error) {
		        console.error("Error:", error);
		        alert("Failed to delete account.");
		    } finally {
		        hideLoading(); // Hide loading after request completes
		    }
		}

    </script>
</head>
<body>
    <div class="container">
        <div class="profile-container">
            <h2>User Profile</h2>
            <div id="profileInfo">Loading...</div>
            <button class="show-update-btn" onclick="showUpdateForm()">Update Profile</button>
            <button class="reset-password-btn" onclick="resetPassword()">Reset Password</button>
			<button class="delete-account-btn" onclick="requestDeleteOTP()">Delete Account</button>
			<button class="back-btn" onclick="window.location.href='dashboard.html'">Back to Dashboard</button>
        </div>
        <div class="update-container">
            <h2>Update Profile</h2>
            <form onsubmit="updateProfile(event)">
                <input type="hidden" id="email">
                <label>First Name: <input type="text" id="firstName" required></label><br>
                <label>Last Name: <input type="text" id="lastName" required></label><br>
                <label>Address: <input type="text" id="address" required></label><br>
                <label>Contact: <input type="text" id="contact" required></label><br>
                <label>Licence: <input type="text" id="licence" required></label><br>
                <label>Licence Image URL: <input type="text" id="licenceImg" required></label><br>
                <button type="submit" class="update-btn">Update Profile</button>
            </form>
        </div>
		
    </div>

	<!-- LOADING OVERLAY -->
	<div id="loadingOverlay" class="loading-overlay" style="display: none;">
	    <div class="loading-text">Processing... Please wait.</div>
	</div>

	
</body>
</html>